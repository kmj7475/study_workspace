<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì£¼ë¬¸ ë“±ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h3 class="mb-4 text-center fw-bold">ğŸ“¦ ì£¼ë¬¸ ë“±ë¡</h3>

  <!-- ì£¼ë¬¸ì ì •ë³´ -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">ì£¼ë¬¸ì ì •ë³´</div>
    <div class="card-body">
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">ì´ë¦„</label>
        <div class="col-sm-10">
          <input type="text" id="receiverName" class="form-control" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
      </div>   
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">ì „í™”ë²ˆí˜¸</label>
        <div class="col-sm-10">
          <input type="text" id="phone" class="form-control" placeholder="010-1234-5678">
        </div>
      </div>
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">ì£¼ì†Œ</label>
        <div class="col-sm-10">
          <input type="text" id="receiverAddr" class="form-control" placeholder="ë°°ì†¡ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
      </div>
    </div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">ì£¼ë¬¸ ìƒí’ˆ</div>
    <div class="card-body">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>ë„ì„œë²ˆí˜¸</th>
            <th>ë„ì„œëª…</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ê¸ˆì•¡</th>
          </tr>
        </thead>
        <tbody id="cartTableBody">
          <tbody>
            <tr th:each="item : ${cartItems}">
                <td th:text="${item.bookNo}"></td>
                <td th:text="${item.bookName}"></td>
                <td th:text="${item.quantity}"></td>
                <td th:text="${item.price}"></td>
                <td class="item-amount" th:text="${item.price * item.quantity}"></td>
            </tr>
        </tbody>
        </tbody>
      </table>

      <div class="text-end mt-3">
        <h5>ì´ ê¸ˆì•¡: <span id="totalAmount" class="fw-bold text-primary" th:text="${totalAmount}">0</span> ì›</h5>
      </div>
    </div>
  </div>

  <!-- í¬ì¸íŠ¸ ì…ë ¥ ë° ì´ê¸ˆì•¡ ê³„ì‚° -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">ê²°ì œ ì •ë³´</div>
    <div class="card-body">
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">ì‚¬ìš© í¬ì¸íŠ¸</label>
        <div class="col-sm-10">
          <input type="number" id="usedPoint" class="form-control" value="0" min="0">
        </div>
      </div>
      <div class="text-end">
        <h5>ê²°ì œ ê¸ˆì•¡: <span id="finalAmount" class="fw-bold text-danger" th:text="${totalAmount}">0</span> ì›</h5>
      </div>
    </div>
  </div>

  
  <!-- ë“±ë¡ ë²„íŠ¼ -->
  <div class="text-center">
    <button id="orderSubmitBtn" class="btn btn-primary px-4 py-2">ì£¼ë¬¸ ë“±ë¡</button>
  </div>
</div>

<script th:inline="javascript">
$(document).ready(function () {
  let cartItems = /*[[${cartItems}]]*/[];
  let totalAmount = /*[[${totalAmount}]]*/0;
  // ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  // $.ajax({
  //   url: "/cart/list",
  //   type: "GET",
  //   success: function (data) {
  //     let total = 0;
  //     let tbody = "";
  //     data.forEach(item => {
  //       let amount = item.bookPrice * item.quantity;
  //       total += amount;
  //       tbody += `
  //         <tr>
  //           <td>${item.bookNo}</td>
  //           <td>${item.bookName}</td>
  //           <td>${item.quantity}</td>
  //           <td>${amount.toLocaleString()} ì›</td>
  //         </tr>
  //       `;
  //     });
  //     $("#cartTableBody").html(tbody);
  //     $("#totalAmount").text(total.toLocaleString());
  //     $("#finalAmount").text(total.toLocaleString());
  //   }
  // });

  // í¬ì¸íŠ¸ ì…ë ¥ ì‹œ ì´ì•¡ ì°¨ê°
  $("#usedPoint").on("input", function () {
    let total = parseInt($("#totalAmount").text().replace(/,/g, "")) || 0;
    let point = parseInt($(this).val()) || 0;
    let finalAmount = Math.max(total - point, 0);
    $("#finalAmount").text(finalAmount.toLocaleString());
  });

  // ì£¼ë¬¸ ë“±ë¡ ë²„íŠ¼ í´ë¦­
  $("#orderSubmitBtn").click(function () {
    
    if (!$("#receiverName").val() || !$("#phone").val() || !$("#receiverAddr").val()) {
      alert("ì£¼ë¬¸ì ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const usedPoint = parseInt($("#usedPoint").val()) || 0;
    let paymentTotal = parseInt($("#finalAmount").text().replace(/,/g, "")) || 0;

    // ì£¼ë¬¸ë°ì´í„° êµ¬ì„±
    const orderRequest = {
      receiverName: $("#receiverName").val(),
      phone: $("#phone").val(),
      receiverAddr: $("#receiverAddr").val(),
      usedPoint: usedPoint,
      orderTotal : totalAmount,
      paymentTotal : paymentTotal,
      orderDetailsList: cartItems.map(item => ({
        bookNo: item.bookNo,
        purchaseQuantity: item.quantity,
        purchasePrice: item.price
      }))
    };

    $.ajax({
      url: "/orders",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(orderRequest),
      success: function (res) {
        alert("ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.href = "/orders/member";
      },
      error: function (xhr) {
        alert("ì£¼ë¬¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });
});
</script>

</body>
</html>
