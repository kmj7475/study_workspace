<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>주문 등록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h3 class="mb-4 text-center fw-bold">📦 주문 등록</h3>

  <!-- 주문자 정보 -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">주문자 정보</div>
    <div class="card-body">
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">이름</label>
        <div class="col-sm-10">
          <input type="text" id="receiverName" class="form-control" placeholder="이름을 입력하세요">
        </div>
      </div>   
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">전화번호</label>
        <div class="col-sm-10">
          <input type="text" id="phone" class="form-control" placeholder="010-1234-5678">
        </div>
      </div>
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">주소</label>
        <div class="col-sm-10">
          <input type="text" id="receiverAddr" class="form-control" placeholder="배송지를 입력하세요">
        </div>
      </div>
    </div>
  </div>

  <!-- 장바구니 목록 -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">주문 상품</div>
    <div class="card-body">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>도서번호</th>
            <th>도서명</th>
            <th>수량</th>
            <th>금액</th>
          </tr>
        </thead>
        <tbody id="cartTableBody">
          <tbody>
            <tr th:each="item : ${cartItems}">
                <td th:text="${item.bookNo}"></td>
                <td th:text="${item.bookName}"></td>
                <td th:text="${item.quantity}"></td>
                <td th:text="${item.price}"></td>
                <td class="item-amount" th:text="${item.price * item.quantity}"></td>
            </tr>
        </tbody>
        </tbody>
      </table>

      <div class="text-end mt-3">
        <h5>총 금액: <span id="totalAmount" class="fw-bold text-primary" th:text="${totalAmount}">0</span> 원</h5>
      </div>
    </div>
  </div>

  <!-- 포인트 입력 및 총금액 계산 -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">결제 정보</div>
    <div class="card-body">
      <div class="row mb-3">
        <label class="col-sm-2 col-form-label">사용 포인트</label>
        <div class="col-sm-10">
          <input type="number" id="usedPoint" class="form-control" value="0" min="0">
        </div>
      </div>
      <div class="text-end">
        <h5>결제 금액: <span id="finalAmount" class="fw-bold text-danger" th:text="${totalAmount}">0</span> 원</h5>
      </div>
    </div>
  </div>

  
  <!-- 등록 버튼 -->
  <div class="text-center">
    <button id="orderSubmitBtn" class="btn btn-primary px-4 py-2">주문 등록</button>
  </div>
</div>

<script th:inline="javascript">
$(document).ready(function () {
  let cartItems = /*[[${cartItems}]]*/[];
  let totalAmount = /*[[${totalAmount}]]*/0;
  // 장바구니 불러오기
  // $.ajax({
  //   url: "/cart/list",
  //   type: "GET",
  //   success: function (data) {
  //     let total = 0;
  //     let tbody = "";
  //     data.forEach(item => {
  //       let amount = item.bookPrice * item.quantity;
  //       total += amount;
  //       tbody += `
  //         <tr>
  //           <td>${item.bookNo}</td>
  //           <td>${item.bookName}</td>
  //           <td>${item.quantity}</td>
  //           <td>${amount.toLocaleString()} 원</td>
  //         </tr>
  //       `;
  //     });
  //     $("#cartTableBody").html(tbody);
  //     $("#totalAmount").text(total.toLocaleString());
  //     $("#finalAmount").text(total.toLocaleString());
  //   }
  // });

  // 포인트 입력 시 총액 차감
  $("#usedPoint").on("input", function () {
    let total = parseInt($("#totalAmount").text().replace(/,/g, "")) || 0;
    let point = parseInt($(this).val()) || 0;
    let finalAmount = Math.max(total - point, 0);
    $("#finalAmount").text(finalAmount.toLocaleString());
  });

  // 주문 등록 버튼 클릭
  $("#orderSubmitBtn").click(function () {
    
    if (!$("#receiverName").val() || !$("#phone").val() || !$("#receiverAddr").val()) {
      alert("주문자 정보를 모두 입력해주세요.");
      return;
    }

    const usedPoint = parseInt($("#usedPoint").val()) || 0;
    let paymentTotal = parseInt($("#finalAmount").text().replace(/,/g, "")) || 0;

    // 주문데이터 구성
    const orderRequest = {
      receiverName: $("#receiverName").val(),
      phone: $("#phone").val(),
      receiverAddr: $("#receiverAddr").val(),
      usedPoint: usedPoint,
      orderTotal : totalAmount,
      paymentTotal : paymentTotal,
      orderDetailsList: cartItems.map(item => ({
        bookNo: item.bookNo,
        purchaseQuantity: item.quantity,
        purchasePrice: item.price
      }))
    };

    $.ajax({
      url: "/orders",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(orderRequest),
      success: function (res) {
        alert("주문이 성공적으로 등록되었습니다!");
        location.href = "/orders/member";
      },
      error: function (xhr) {
        alert("주문 등록 중 오류가 발생했습니다.");
      }
    });
  });
});
</script>

</body>
</html>
