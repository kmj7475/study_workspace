<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>주문 페이지</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container mt-5">
    <h2>주문 생성</h2>
    <form id="orderForm" class="mb-5">
      <div class="mb-3">
        <label for="memberNo" class="form-label">회원 번호</label>
        <input type="number" class="form-control" id="memberNo" required>
      </div>
      <div class="mb-3">
        <label for="receiverName" class="form-label">받는 사람</label>
        <input type="text" class="form-control" id="receiverName" required>
      </div>
      <div class="mb-3">
        <label for="receiverAddr" class="form-label">배송 주소</label>
        <input type="text" class="form-control" id="receiverAddr" required>
      </div>
      <div class="mb-3">
        <label for="phone" class="form-label">연락처</label>
        <input type="text" class="form-control" id="phone" pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
          placeholder="예: 010-1234-5678" required>
      </div>
      <div class="order-items" id="orderItems">
        <div class="order-item mb-4 border p-3">
          <h4>주문 상품 #1</h4>
          <div class="mb-3">
            <label class="form-label">책 번호</label>
            <input type="number" class="form-control book-no" required>
          </div>
          <div class="mb-3">
            <label class="form-label">수량</label>
            <input type="number" class="form-control quantity" required>
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-secondary mb-3" onclick="addOrderItem()">상품 추가</button>
      <button type="submit" class="btn btn-primary d-block">주문하기</button>
    </form>

    <h2>주문 목록</h2>
    <table class="table">
      <thead>
        <tr>
          <th>주문 번호</th>
          <th>회원 번호</th>
          <th>총 금액</th>
          <th>주문 상세</th>
        </tr>
      </thead>
      <tbody id="orderList">
      </tbody>
    </table>
  </div>

  <script>
    // 주문 상품 추가
    function addOrderItem() {
      const orderItems = document.getElementById('orderItems');
      const itemCount = orderItems.children.length + 1;

      const orderItem = document.createElement('div');
      orderItem.className = 'order-item mb-4 border p-3';
      orderItem.innerHTML = `
                <h4>주문 상품 #${itemCount}</h4>
                <div class="mb-3">
                    <label class="form-label">책 번호</label>
                    <input type="number" class="form-control book-no" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">수량</label>
                    <input type="number" class="form-control quantity" required>
                </div>
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">삭제</button>
            `;
      orderItems.appendChild(orderItem);
    }

    // 주문 생성
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const memberNo = document.getElementById('memberNo').value;
      const orderItems = document.getElementsByClassName('order-item');

      try {
        // 1. Order 생성
        const receiverName = document.getElementById('receiverName').value;
        const receiverAddr = document.getElementById('receiverAddr').value;
        const phone = document.getElementById('phone').value;

        const orderResponse = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            memberNo: memberNo,
            receiverName: receiverName,
            receiverAddr: receiverAddr,
            phone: phone
          }),
        });

        if (!orderResponse.ok) {
          throw new Error('주문 생성 실패');
        }

        const order = await orderResponse.json();

        // 2. OrderDetails 생성
        for (const item of orderItems) {
          const bookNo = item.querySelector('.book-no').value;
          const quantity = item.querySelector('.quantity').value;

          await fetch('/api/order-details', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              orderNo: order.orderNo,
              bookNo: bookNo,
              purchaseQuantity: quantity
            }),
          });
        }

        loadOrders();
        document.getElementById('orderForm').reset();
        document.getElementById('orderItems').innerHTML = `
                    <div class="order-item mb-4 border p-3">
                        <h4>주문 상품 #1</h4>
                        <div class="mb-3">
                            <label class="form-label">책 번호</label>
                            <input type="number" class="form-control book-no" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">수량</label>
                            <input type="number" class="form-control quantity" required>
                        </div>
                    </div>
                `;
      } catch (error) {
        console.error('Error:', error);
        alert('주문 처리 중 오류가 발생했습니다.');
      }
    });

    // 주문 목록 로드
    async function loadOrders() {
      try {
        const response = await fetch('/api/orders');
        const orders = await response.json();

        const orderList = document.getElementById('orderList');
        orderList.innerHTML = '';

        orders.forEach(order => {
          const row = document.createElement('tr');
          row.innerHTML = `
                        <td>${order.orderNo}</td>
                        <td>${order.memberNo}</td>
                        <td>${order.totalAmount}</td>
                        <td>
                            <button onclick="showOrderDetails(${order.orderNo})" 
                                    class="btn btn-info btn-sm">상세보기</button>
                            <button onclick="deleteOrder(${order.orderNo})" 
                                    class="btn btn-danger btn-sm">삭제</button>
                        </td>
                    `;
          orderList.appendChild(row);
        });
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // 주문 상세 정보 조회
    async function showOrderDetails(orderNo) {
      try {
        const response = await fetch(`/api/order-details/order/${orderNo}`);
        const details = await response.json();

        let message = '주문 상세 내역:\n\n';
        details.forEach(detail => {
          message += `책 번호: ${detail.bookNo}\n`;
          message += `수량: ${detail.purchaseQuantity}\n`;
          message += `가격: ${detail.purchasePrice}\n`;
          message += `합계: ${detail.purchaseAmount}\n\n`;
        });

        alert(message);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // 주문 삭제
    async function deleteOrder(orderNo) {
      if (!confirm('주문을 삭제하시겠습니까?')) return;

      try {
        const response = await fetch(`/api/orders/${orderNo}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          loadOrders();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // 초기 로드
    loadOrders();
  </script>
</body>

</html>